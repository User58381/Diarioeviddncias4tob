<!doctype html>
<html lang="es" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aula Digital ‚Äî Diario docente</title>
<style>
  :root{
    --bg:#f7f9ff; --card:#ffffff; --text:#0b1020; --muted:#526072; --accent:#2b6bff;
    --bd:#d9e3ff; --ok:#0ea371; --warn:#f0b429; --bad:#ef4444;
    --barbg: color-mix(in oklab, var(--card) 80%, transparent);
    --materiaSepSpace: 12px;
  }
  [data-theme="dark"]{
    --bg:#0c1220; --card:#101a34; --text:#eaf3ff; --muted:#93a6bc; --accent:#6aa9ff;
    --bd:#223056; --ok:#1ec48d; --warn:#ffce3a; --bad:#ff7a7a; --barbg:#0a1330;
    --materiaSepSpace: 12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:color-mix(in oklab,var(--card) 90%,transparent);
    backdrop-filter:blur(6px);border-bottom:1px solid var(--bd);padding:14px 16px;display:flex;gap:12px;align-items:center}
  header h1{font-size:18px;margin:0}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;touch-action:manipulation}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--text)}
  .btn.small{padding:8px 10px;border-radius:10px}
  main{max-width:1100px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px}
  .hero{display:grid;gap:12px}
  .input{display:grid;grid-template-columns:1fr auto auto;gap:8px}
  @media (max-width:720px){.input{grid-template-columns:1fr}}
  .input input{padding:14px 16px;border:1px solid var(--bd);border-radius:12px;background:white;font-size:16px}
  [data-theme="dark"] .input input{background:#0d152b;color:var(--text)}
  .hint{color:var(--muted);font-size:13px}
  h2{margin:8px 0 6px 0}
  h3{margin:10px 0 8px 0}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:920px){.grid2{grid-template-columns:1fr 1fr}}
  .grid3{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:920px){.grid3{grid-template-columns:1fr 1fr 1fr}}
  .list{display:grid;gap:8px}
  details{border:1px solid var(--bd);border-radius:12px;padding:8px 10px;background:color-mix(in oklab,var(--card) 94%,transparent)}
  summary{cursor:pointer;font-weight:700}
  .stat{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){.stat{grid-template-columns:1fr}}
  .k{color:var(--muted);font-size:14px}
  .v{font-weight:900;font-size:20px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
  .chip{border:1px solid var(--bd);background:transparent;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .badgeb{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px}
  .footer-note{margin-top:12px;font-size:12px;color:var(--muted)}
  .chart{display:grid;gap:10px;margin-top:14px}
  .bar{position:relative;border-radius:12px;border:1px solid var(--bd);background:var(--barbg);height:44px;display:flex;align-items:center;overflow:hidden}
  .bar::before{content:"";position:absolute;inset:0;transform-origin:left center;transform:scaleX(var(--pct,0))}
  .bar.fal::before{background:linear-gradient(90deg,var(--bad),#ff9b9b)}
  .bar.tar::before{background:linear-gradient(90deg,var(--warn),#ffe08a)}
  .bar.ati::before{background:linear-gradient(90deg,var(--ok),#a7efd5)}
  .bar .lbl{position:relative;z-index:1;padding-left:12px;font-weight:800}
  .bar .val{position:absolute;right:10px;z-index:1;font-weight:900}
  .linkbtn{display:inline-block;margin-left:8px;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;font-size:12px;text-decoration:none}

  /* Sugerencias + lista completa */
  .suggest{position:relative}
  .suggest-list{position:absolute;z-index:15;left:0;right:0;top:calc(100% + 6px);background:var(--card);border:1px solid var(--bd);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);max-height:300px;overflow:auto;display:none}
  .sg-item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;gap:8px}
  .sg-item:hover{background:color-mix(in oklab,var(--card) 85%,transparent)}
  .tag{font-size:12px;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .soft{background:color-mix(in oklab,var(--card) 93%,transparent);border:1px dashed var(--bd)}

  /* TOPS + buscador */
  .tops{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:920px){.tops{grid-template-columns:repeat(3,1fr)}}
  .ritem{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--bd);border-radius:10px;padding:8px 10px;background:color-mix(in oklab,var(--card) 96%,transparent)}
  .rmeta{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;color:var(--muted)}

  .scope-chips{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .scope-chip{border:1px solid var(--bd);background:transparent;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;font-size:13px}
  .scope-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .search-results{max-height:280px;overflow:auto;margin-top:6px}
  .search-empty{color:var(--muted);font-size:13px}

  /* Separadores por materia (vista alumno) */
  .materia-sep{
    margin: var(--materiaSepSpace) 0 6px;
    padding-top: 6px;
    border-top: 1px solid var(--bd);
    font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.3px; text-transform:uppercase;
  }
  .mini{font-size:12px;color:var(--muted);margin-top:2px}
</style>
</head>
<body>
<header>
  <h1>üìò Aula Digital ‚Äî Diario docente</h1>
  <div class="right">
    <button id="themeBtn" class="btn ghost small" title="Cambiar tema">üåô Oscuro</button>
  </div>
</header>

<main>
  <!-- Buscar alumno -->
  <section class="card hero" id="search-card">
    <div>
      <h2>Buscar alumno</h2>
      <p class="hint">Escriba <b>nombre o ID</b> para abrir la vista del alumno. No requiere el c√≥digo de familias.</p>
    </div>

    <div class="suggest">
      <div class="input">
        <input id="searchInput" autocomplete="off" placeholder="Ej.: MARTINEZ HERNANDEZ DYLAN‚Ä¶ o ID07ABC123" inputmode="latin-name">
        <button id="openBtn" class="btn primary">Abrir</button>
        <button id="saveBtn" class="btn ghost">Recordar b√∫squeda</button>
      </div>
      <div id="sgBox" class="suggest-list"></div>
      <div class="hint">Con 2+ letras ver√°s sugerencias. Tambi√©n puedes pegar el ID.</div>
    </div>

    <div class="card soft" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="listAllBtn" class="btn ghost small">Ver lista completa</button>
          <span class="hint">total: <b id="stdCount">0</b></span>
        </div>
        <div class="row">
          <button id="prevBtn" class="btn ghost small" title="Alumno anterior">‚óÄ</button>
          <button id="nextBtn" class="btn ghost small" title="Siguiente alumno">‚ñ∂</button>
        </div>
      </div>
      <div id="allList" class="list" style="max-height:260px;overflow:auto;margin-top:8px;display:none"></div>
      <div class="hint">Haz clic en un nombre para abrirlo.</div>
    </div>

    <div class="hint" style="margin-top:6px">Este sitio <u>solo lee</u> datos del cuaderno digital.</div>
  </section>

  <!-- Tops -->
  <section class="card" id="tops-card" style="margin-top:14px;display:none">
    <div class="topbar">
      <div>
        <h2>üèÜ Top 7</h2>
        <div class="hint" id="tops-sub">Se actualiza con <b>Todo</b> / M1 / M2 / M3</div>
      </div>
      <div class="row">
        <button id="recalcTopsBtn" class="btn ghost small" title="Recalcular tops">‚Üª Recalcular</button>
      </div>
    </div>
    <div class="tops" style="margin-top:8px">
      <div>
        <h3>Asistencia</h3>
        <div id="top-asist" class="list"></div>
      </div>
      <div>
        <h3>Trabajos</h3>
        <div id="top-trab" class="list"></div>
      </div>
      <div>
        <h3>General</h3>
        <div id="top-total" class="list"></div>
      </div>
    </div>
  </section>

  <!-- Buscador de trabajos -->
  <section class="card" id="work-search-card" style="margin-top:14px">
    <div class="topbar">
      <div>
        <h2>üîé Buscar trabajos</h2>
        <div class="hint">Busca por <b>nombre del trabajo</b>, <b>materia</b> o <b>momento</b> (ej.: ‚ÄúM1 ciencias‚Äù, ‚Äúlibreta ecosistema‚Äù).</div>
      </div>
      <div class="row">
        <div class="scope-chips" id="scope-chips">
          <button class="scope-chip active" data-scope="AUTO">Auto</button>
          <button class="scope-chip" data-scope="GENERAL">General</button>
          <button class="scope-chip" data-scope="ALUMNO">Alumno</button>
        </div>
      </div>
    </div>

    <div class="input" style="grid-template-columns:1fr auto">
      <input id="workSearchInput" autocomplete="off" placeholder="Ej.: M2 biolog√≠a ecosistema ¬∑ libreta p.23‚Ä¶" inputmode="latin-name">
      <button id="clearWorkSearch" class="btn ghost">Limpiar</button>
    </div>
    <div class="hint" id="workSearchHint">√Åmbito: <b>Auto</b>. Si hay alumno abierto, busca en sus faltantes; si no, busca en todos los presets.</div>
    <div id="workSearchResults" class="list search-results"></div>
  </section>

  <!-- Resultados por alumno -->
  <section id="student-view" style="display:none; margin-top:14px">
    <div class="card">
      <div class="topbar">
        <div>
          <h2 id="alumno-nombre">Alumno</h2>
          <div class="hint" id="alumno-id"></div>
          <div class="hint" id="grupo-label" style="margin-top:4px"></div>
          <div id="tri-subtitle" class="hint" style="margin-top:6px">Resumen de Todo</div>
        </div>
        <div>
          <button id="backBtn" class="btn ghost">Cambiar de alumno</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="chips" id="tri-chips"></div>
        <div class="hint">Vea <b>Todo</b> o solo un trimestre: <b>M1</b>, <b>M2</b>, <b>M3</b>.</div>
      </div>

      <div class="stat" style="margin-top:12px">
        <div><div class="k">Cumplimiento (trimestre)</div><div class="v" id="stat-cump-tri">‚Äì</div></div>
        <div><div class="k">Totales ‚Äî Trimestre</div><div class="v" id="stat-tot-tri">‚Äì</div></div>
        <div><div class="k">Asistencia ‚Äî semana</div><div class="v" id="stat-aswk">‚Äì</div></div>
        <div><div class="k">Asistencia ‚Äî 30 d√≠as</div><div class="v" id="stat-as30">‚Äì</div></div>
        <div><div class="k">Asistencia total (hist√≥rica)</div><div class="v" id="stat-asHist">‚Äì</div></div>
        <div><div class="k">Faltas (hist√≥ricas)</div><div class="v" id="stat-faltHist">‚Äì</div></div>
      </div>

      <div class="chart" aria-label="Resumen visual del trimestre">
        <div class="bar fal" id="bar-fal"><span class="lbl">‚è≥ Faltantes</span><span class="val" id="val-fal">0</span></div>
        <div class="bar tar" id="bar-tar"><span class="lbl">üïí Tarde</span><span class="val" id="val-tar">0</span></div>
        <div class="bar ati" id="bar-ati"><span class="lbl">‚úÖ A tiempo</span><span class="val" id="val-ati">0</span></div>
      </div>

      <p class="footer-note" style="margin-top:10px">
        Vista informativa para docente. Todo se calcula <b>solo leyendo</b> las hojas.
      </p>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h3>‚è≥ Trabajos faltantes</h3>
        <div id="faltantes" class="list"></div>
      </div>
      <div class="card">
        <h3>üïí Entregados tarde</h3>
        <div id="tarde" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>‚úÖ Entregados (a tiempo)</h3>
      <div id="atiempo" class="list"></div>
    </div>
  </section>
</main>

<script>
/* ====== CONFIG (tu Drive) ====== */
let SHEET_ID = '1SWtGmXlf7WbNvUlJBDktXpDcq5OfJkHE75bH5nkxurk';
let GIDS = {
  puntos:     '0',
  asistencia: '280572348',
  registro:   '1343140445',
  presets:    '104702199'
};
let GROUP_LABEL = '4to A Matutino';
let SCHOOL_YEAR_START = '2025-09-01';

/* Overrides por querystring (opcional) */
(function applyOverridesFromURL(){
  const q = new URLSearchParams(location.search);
  if (q.get('sheet')) SHEET_ID = q.get('sheet');
  if (q.get('asis'))  GIDS.asistencia = q.get('asis');
  if (q.get('reg'))   GIDS.registro   = q.get('reg');
  if (q.get('pre'))   GIDS.presets    = q.get('pre');
  if (q.get('group')) GROUP_LABEL     = q.get('group');
  if (q.get('start')) SCHOOL_YEAR_START = q.get('start');
  console.log('[CFG]', {SHEET_ID, GIDS, GROUP_LABEL, SCHOOL_YEAR_START});
})();

/* JSON evidencias (opcional) */
let LINKS_JSON = 'data/links_4A.json';
let LINKMAP = {};

/* Pesos del score total (A/T/P) */
const TOP_WEIGHTS = { asistencia:0.40, trabajos:0.30, puntos:0.30 };

/* ====== UTIL ====== */
const $  = s => document.querySelector(s);
const strip = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const norm  = s => strip(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const pad   = n => String(n).padStart(2,'0');
const ymd   = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const TODAY = new Date();
const MONTHS_ES = {ene:0,feb:1,mar:2,abr:3,may:4,jun:5,jul:6,ago:7,sep:8,sept:8,oct:9,nov:10,dic:11};
function toLocalDate(value){ if (value instanceof Date) return value; const s=String(value||'').trim(); const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if(m) return new Date(+m[1],+m[2]-1,+m[3]); return new Date(s); }
const isWeekend = v => { const d = toLocalDate(v); const k = d.getDay(); return k===0 || k===6; };
const minIso = (a,b)=> (a && b) ? (a<b?a:b) : (a||b||'');
const maxIso = (a,b)=> (a && b) ? (a>b?a:b) : (a||b||'');

/* ====== ID / fechas ====== */
function findIDColumn(cols, rows){
  let idx = cols.findIndex(c => String(c||'').trim().toUpperCase() === 'ID');
  if (idx >= 0) return idx;
  idx = cols.findIndex(c => /^(id|matric)/i.test(String(c||'')));
  if (idx >= 0) return idx;
  let best=-1, bestOk=-1;
  for (let i=0;i<cols.length;i++){
    let ok=0, tot=0;
    for (let r=0;r<Math.min(rows.length,50);r++){
      const v = String(rows[r]?.[i] ?? '').trim();
      if (!v) continue; tot++; if (/^ID[A-Z0-9]{6,}$/i.test(v)) ok++;
    }
    if (tot && ok/tot>=0.5) return i;
    if (ok>bestOk){bestOk=ok;best=i;}
  }
  return best;
}
function excelSerialToDate(n){
  const baseUTC = new Date(Date.UTC(1899,11,30));
  const dUTC = new Date(baseUTC.getTime() + Math.round(Number(n))*86400000);
  return new Date(dUTC.getFullYear(), dUTC.getMonth(), dUTC.getDate());
}
function normDate(s){
  const t = String(s??'').trim();
  if(!t) return '';
  if (/^\d+(\.\d+)?$/.test(t)){
    const n = +t; if (n >= 35000 && n <= 80000){ const d = excelSerialToDate(n); return ymd(d); }
  }
  let m = /^(\d{4})-(\d{1,2})-(\d{1,2})(?:[ T].*)?$/.exec(t);
  if (m){ const d = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(+d)?'':ymd(d); }
  m = /^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})$/.exec(t);
  if (m){
    const a = new Date(+m[3], +m[2]-1, +m[1]);
    const b = new Date(+m[3], +m[1]-1, +m[2]);
    const d = (!isNaN(+a) && !isNaN(+b))
      ? (Math.abs(+a - +TODAY) <= Math.abs(+b - +TODAY) ? a : b)
      : (!isNaN(+a)) ? a : (!isNaN(+b)) ? b : null;
    return d ? ymd(d) : '';
  }
  m = /^(\d{1,2})[\s\-\/]([A-Za-z√°√©√≠√≥√∫√±]+)[\s\-\/](\d{4})$/i.exec(t);
  if (m){
    const k = m[2].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const key = k.startsWith('sept') ? 'sept' : k.slice(0,3);
    const mi = MONTHS_ES[key];
    if (mi!=null){ const d = new Date(+m[3], mi, +m[1]); return isNaN(+d)?'':ymd(d); }
  }
  const d = new Date(t);
  return isNaN(+d) ? '' : ymd(d);
}
function parseHeaderDateLabel(lbl){
  if (typeof lbl === 'number' && isFinite(lbl)){
    if (lbl >= 35000 && lbl <= 80000){ const d = excelSerialToDate(lbl); return { iso: ymd(d), date: d }; }
  }
  const r = String(lbl??'').trim();
  if (!r) return null;
  if (/^\d+(\.\d+)?$/.test(r)){
    const n = +r; if (n >= 35000 && n <= 80000){ const d = excelSerialToDate(n); return { iso: ymd(d), date: d }; }
  }
  let m = /^(\d{4})-(\d{1,2})-(\d{1,2})(?:[ T].*)?$/.exec(r);
  if (m){ const d = new Date(+m[1], +m[2]-1, +m[3]); if (!isNaN(+d)) return { iso: ymd(d), date: d }; }
  m = /^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})$/.exec(r);
  if (m){
    const a = new Date(+m[3], +m[2]-1, +m[1]);
    const b = new Date(+m[3], +m[1]-1, +m[2]);
    const d = (!isNaN(+a) && !isNaN(+b))
      ? (Math.abs(+a - +TODAY) <= Math.abs(+b - +TODAY) ? a : b)
      : (!isNaN(+a)) ? a : (!isNaN(+b)) ? b : null;
    if (d) return { iso: ymd(d), date: d };
  }
  m = /^(\d{1,2})[\s\-\/]([A-Za-z√°√©√≠√≥√∫√±]+)[\s\-\/](\d{4})$/i.exec(r);
  if (m){
    const k = m[2].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const key = k.startsWith('sept') ? 'sept' : k.slice(0,3);
    const mi = MONTHS_ES[key];
    if (mi!=null){ const d = new Date(+m[3], mi, +m[1]); if (!isNaN(+d)) return { iso: ymd(d), date: d }; }
  }
  const d = new Date(r);
  return isNaN(+d) ? null : { iso: ymd(d), date: new Date(d.getFullYear(), d.getMonth(), d.getDate()) };
}
function getDateColInfo(cols){
  const out = [];
  for (let i = 0; i < cols.length; i++){
    const info = parseHeaderDateLabel(cols[i]);
    if (info) out.push({ i, ...info });
  }
  return out;
}

/* ====== LECTORES ====== */
let _cbSeq=0;
function fetchGViz(sheetId, sheetName){
  return new Promise((resolve,reject)=>{
    const cb=`__cb_${Date.now()}_${++_cbSeq}`;
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?headers=1&tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const sc=document.createElement('script');
    const timeout=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},12000);
    function cleanup(){clearTimeout(timeout); delete window[cb]; if(sc.parentNode) sc.parentNode.removeChild(sc); }
    window[cb]=(json)=>{cleanup(); try{
      let cols=(json.table?.cols||[]).map(c=>c?.label ?? '');
      let rows=(json.table?.rows||[]).map(r=>(r.c||[]).map(c=>c?.v ?? ''));
      cols = cols.map(v=> (typeof v==='string'||typeof v==='number') ? v : String(v||'').trim());
      const empty=cols.filter(c=>String(c||'').trim()===''||/^[A-Z]$/.test(String(c))).length;
      if(empty>=Math.ceil(cols.length*0.5)&&rows.length){cols=rows[0].map(v=>v); rows=rows.slice(1);}
      resolve({cols,rows});
    }catch(e){reject(e)} };
    sc.onerror=()=>{cleanup();reject(new Error('Error GViz'))};
    sc.src=url; document.head.appendChild(sc);
  });
}
async function fetchCSVByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&ts=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('CSV '+gid);
  const txt=await res.text(); const rows=parseCSV(txt); const cols=(rows.shift()||[]).map(v=>v); return {cols,rows};
}
function parseCSV(t){
  const rows=[]; let row=[], cur='', q=false;
  for(let i=0;i<t.length;i++){const ch=t[i],nx=t[i+1];
    if(q){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){q=false;} else cur+=ch; }
    else { if(ch==='"'){q=true;} else if(ch===','){row.push(cur);cur='';}
      else if(ch==='\n'||ch==='\r'){ if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';} }
      else cur+=ch; } }
  if(cur!==''||row.length){row.push(cur);rows.push(row);} return rows;
}

/* ====== PARSERS ====== */
function parseRegistro(cols,rows){
  const iUID=cols.findIndex(c=>/uid[_ ]?[_ ]?preset/i.test(String(c)));
  const iF=cols.findIndex(c=>/^fecha$/i.test(String(c)));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(String(c)));
  const iID=cols.findIndex(c=>/^(id|matric)/i.test(String(c)));
  const iNom=cols.findIndex(c=>/^nombre/i.test(String(c)));
  const iMat=cols.findIndex(c=>/^materia$/i.test(String(c)));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?¬∞/i.test(String(c)));
  const iOri=cols.findIndex(c=>/^origen$/i.test(String(c)));
  const iPag=cols.findIndex(c=>/^p[a√°]gina/i.test(String(c)));
  const iPts=cols.findIndex(c=>/^puntos$/i.test(String(c)));
  const iAtr=cols.findIndex(c=>/atraso/i.test(String(c)));
  const iMom=cols.findIndex(c=>/^momento$/i.test(String(c)));
  const iNomT=cols.findIndex(c=>/nombre.*trabajo/i.test(String(c)));
  return rows.map(r=>{
    const fecha=String(r[iF]??'').trim(); const fo=String((iFO>=0?r[iFO]:'')??'').trim()||fecha;
    const atraso = (()=>{ if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d=new Date(fecha), o=new Date(fo); if(isNaN(+d)||isNaN(+o)) return 0; return Math.max(0, Math.round((d-o)/86400000));})();
    return { uidPreset:String((iUID>=0?r[iUID]:'')??'').trim(), fecha, fechaObjetivo:fo, id:String((iID>=0?r[iID]:'')??'').trim(),
      nombre:String((iNom>=0?r[iNom]:'')??'').trim(), materia:String((iMat>=0?r[iMat]:'')??'').trim(),
      numero:String((iNum>=0?r[iNum]:'')??'').trim(), origen:String((iOri>=0?r[iOri]:'')??'').trim(),
      pagina:String((iPag>=0?r[iPag]:'')??'').trim(), puntos:+((iPts>=0?r[iPts]:0)??0)||0,
      atrasoDias:atraso, momento:String((iMom>=0?r[iMom]:'')??'').trim(), nombreTrabajo:String((iNomT>=0?r[iNomT]:'')??'').trim()
    };
  });
}
function parsePresets(cols,rows){
  const iUID=cols.findIndex(c=>/uid[_ ]?[_ ]?preset/i.test(String(c)));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(String(c)));
  const iMom=cols.findIndex(c=>/^momento$/i.test(String(c)));
  const iMat=cols.findIndex(c=>/^materia$/i.test(String(c)));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?¬∞/i.test(String(c)));
  const iOri=cols.findIndex(c=>/^origen$/i.test(String(c)));
  const iPag=cols.findIndex(c=>/^p[a√°]gina/i.test(String(c)));
  const iNom=cols.findIndex(c=>/nombre.*trabajo/i.test(String(c)));
  return rows.map(r=>({uid:String((iUID>=0?r[iUID]:'')??'').trim(),
    fechaObjetivo:String((iFO>=0?r[iFO]:'')??'').trim(), momento:String((iMom>=0?r[iMom]:'')??'').trim(),
    materia:String((iMat>=0?r[iMat]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(),
    origen:String((iOri>=0?r[iOri]:'')??'').trim(), pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
    nombreTrabajo:String((iNom>=0?r[iNom]:'')??'').trim()})).filter(p=>p.uid);
}

/* ====== ASISTENCIA ====== */
function isPresent(v){
  const s = norm(v);
  if(!s) return false;
  if(!Number.isNaN(+s)) return (+s) > 0;
  const s2 = s.replace(/\s+/g,'');
  if(/^1\(100%?\)$/.test(s2)) return true;
  return ['x','‚úì','‚úî','p','presente','si','s√≠','s','ok','true','asistio','asisti√≥'].includes(s);
}
function asistenciaAlumno(cols,rows,ref,start,end,opts={}){
  const iId  = findIDColumn(cols, rows);
  const iNom = cols.findIndex(c=>/^nombre/i.test(String(c)));
  let row = null;
  if (iId >= 0 && ref.id) row = rows.find(r => norm(r[iId]) === norm(ref.id));
  if (!row && iNom >= 0 && ref.nombre) row = rows.find(r => norm(r[iNom]) === norm(ref.nombre));
  if (!row) return {present:0,total:0,row:null};

  let infos = getDateColInfo(cols).filter(x => x.iso >= start && x.iso <= end);
  if (opts.excludeWeekends) infos = infos.filter(x => !isWeekend(x.iso));

  let present = 0, total = 0;
  for (const info of infos){
    const v = row[info.i];
    total++; if (isPresent(v)) present++;
  }
  return {present,total,row};
}
function asistenciaHistorica(cols,rows,ref,opts={}){
  const iId  = findIDColumn(cols, rows);
  const iNom = cols.findIndex(c=>/^nombre/i.test(String(c)));
  let row = null;
  if (iId >= 0 && ref.id) row = rows.find(r => norm(r[iId]) === norm(ref.id));
  if (!row && iNom >= 0 && ref.nombre) row = rows.find(r => norm(r[iNom]) === norm(ref.nombre));
  if (!row) return {present:0,total:0};

  let infos = getDateColInfo(cols).filter(x => x.iso >= SCHOOL_YEAR_START);
  if (opts.excludeWeekends) infos = infos.filter(x => !isWeekend(x.iso));

  let present = 0, total = 0;
  for (const info of infos){
    const v = rows.find(r => norm(r[iId])===norm(ref.id))?.[info.i];
    total++; if (isPresent(v)) present++;
  }
  return {present,total};
}

/* Semana actual (lun-vie) */
function weekRange(d){
  const day=d.getDay(); const diff=(day===0?-6:1-day);
  const mon=new Date(d); mon.setDate(d.getDate()+diff); mon.setHours(0,0,0,0);
  const fri=new Date(mon); fri.setDate(mon.getDate()+4);
  return [ymd(mon), ymd(fri)];
}

/* ====== DIRECTORIO ====== */
let STUDENTS = [];
function buildStudentIndexFromAsis(asis){
  const iId  = findIDColumn(asis.cols, asis.rows);
  let iNom = asis.cols.findIndex(c=>/^nombre/i.test(String(c||'')));
  if (iNom<0){
    let best=-1, bestScore=-1;
    for (let j=0; j<asis.cols.length; j++){
      let score=0;
      for (let r=0; r<Math.min(asis.rows.length,120); r++){
        const v=String(asis.rows[r]?.[j]||'');
        if(/\b\p{L}{2,}\s+\p{L}{2,}\b/u.test(v)) score++;
      }
      if(score>bestScore){bestScore=score;best=j;}
    }
    iNom=best;
  }
  if (iId<0 || iNom<0) return [];
  const seen=new Set(), arr=[];
  for(const r of asis.rows){
    const id=String(r[iId]||'').trim();
    const nom=String(r[iNom]||'').trim();
    if(id && nom && !seen.has(id)){ seen.add(id); arr.push({id, nombre:nom}); }
  }
  return arr.sort((a,b)=> a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
}
function renderAllList(){
  $('#stdCount').textContent = STUDENTS.length;
  const host=$('#allList');
  host.innerHTML = STUDENTS.map((s,i)=>`<div class="sg-item" data-k="${i}">
    <span>${s.nombre}</span><span class="tag">${s.id}</span></div>`).join('');
  host.querySelectorAll('.sg-item').forEach(el=>{
    el.onclick=()=>openStudentByIndex(+el.getAttribute('data-k'));
  });
}

/* ====== GLOBALES ====== */
let ALL = {faltantes:[], tarde:[], atiempo:[], presets:[]};
let TRI='ALL';
let CURRENT_INDEX=-1;
let DATA = { asis:null, reg:null, pre:null };

/* ====== Lectores de bloques ====== */
async function loadBlock(name){
  const names = {asistencia:'Asistencia', registro:'Registro de trabajos', presets:'Presets'};
  try{ return await fetchGViz(SHEET_ID, names[name]); }
  catch{
    const gid = GIDS[name];
    if(!gid||gid==='0') throw new Error('Sin GID para '+name);
    return await fetchCSVByGid(SHEET_ID, gid);
  }
}
async function loadLinks(){
  try{
    const r=await fetch(LINKS_JSON,{cache:'no-store'});
    if(r.ok){
      const j=await r.json();
      if(j?.items) LINKMAP=j.items;
    }
  }catch(e){ console.warn('No se pudo cargar LINKS_JSON', e); }
}

/* ====== TOPS ====== */
function triRangeFromPresets(presets, tri){
  if(tri==='ALL') return {start:SCHOOL_YEAR_START, end:ymd(TODAY)};
  const items = presets.filter(p => String(p.momento||'').toUpperCase()===tri && normDate(p.fechaObjetivo));
  if(!items.length) return {start:SCHOOL_YEAR_START, end:ymd(TODAY)};
  const ds = items.map(p => new Date(normDate(p.fechaObjetivo))).sort((a,b)=>a-b);
  return {start: ymd(ds[0]), end: ymd(ds[ds.length-1])};
}
function computeMaxPointsByPreset(entregas, presets, tri){
  const ids = new Set(presets.filter(p=> tri==='ALL' || String(p.momento||'').toUpperCase()===tri).map(p=>p.uid));
  const map = {};
  for(const e of entregas){
    if(e.uidPreset && ids.has(e.uidPreset)){
      if(!map[e.uidPreset] || e.puntos>map[e.uidPreset]) map[e.uidPreset]=e.puntos||0;
    }
  }
  const defaultMax = 10;
  const totalMax = Array.from(ids).reduce((s,uid)=> s + (map[uid] ?? defaultMax), 0);
  return { map, totalMax };
}
function computeTopStats(asis, entregas, presets, tri){
  const presetTri = presets.filter(p=> tri==='ALL' || String(p.momento||'').toUpperCase()===tri);
  const presetIds = new Set(presetTri.map(p=>p.uid));
  const worksTotal = presetTri.length;
  const {start,end} = triRangeFromPresets(presets, tri);
  const ptsInfo = computeMaxPointsByPreset(entregas, presets, tri);

  const iId  = findIDColumn(asis.cols, asis.rows);
  const iNom = asis.cols.findIndex(c=>/^nombre/i.test(String(c||'')));
  const byStu = new Map();

  for(const e of entregas){
    if(!e.id) continue;
    if(tri!=='ALL' && String(e.momento||'').toUpperCase()!==tri) continue;
    if(e.uidPreset && presetIds.size && !presetIds.has(e.uidPreset)) continue;
    let m = byStu.get(e.id); if(!m){ m=new Map(); byStu.set(e.id,m); }
    const k = e.uidPreset || [norm(e.materia), norm(String(e.numero).replace(/^trabajo\s*/i,'')),
                              norm(e.origen), norm(e.pagina), normDate(e.fechaObjetivo)].join('|');
    const prev = m.get(k);
    if(!prev || (e.puntos||0)>(prev.puntos||0)) m.set(k,e);
  }

  const stats=[];
  for(const row of asis.rows){
    const id = String(row[iId]||'').trim();
    const nombre = String(row[iNom]||'').trim();
    if(!id || !nombre) continue;

    const a = asistenciaAlumno(asis.cols, asis.rows, {id, nombre}, start, end, {excludeWeekends:true});
    const ent = byStu.get(id);
    const done = ent ? Array.from(ent.values()).length : 0;
    const puntos = ent ? Array.from(ent.values()).reduce((s,e)=> s + (e.puntos||0), 0) : 0;

    const asistPct = a.total ? a.present/a.total : 0;
    const trabPct  = worksTotal ? done/worksTotal : 0;
    const ptsPct   = ptsInfo.totalMax ? puntos/ptsInfo.totalMax : 0;
    const score = TOP_WEIGHTS.asistencia*asistPct + TOP_WEIGHTS.trabajos*trabPct + TOP_WEIGHTS.puntos*ptsPct;

    stats.push({
      id, nombre,
      asist_present:a.present, asist_total:a.total,
      trab_done:done, trab_total:worksTotal,
      pts:puntos, pts_total:ptsInfo.totalMax,
      asist_pct:asistPct, trab_pct:trabPct, pts_pct:ptsPct, score
    });
  }
  return stats;
}
function renderTopList(hostId, arr, fmt){
  const host=$(hostId);
  host.innerHTML = arr.slice(0,7).map(s=>`
    <div class="ritem">
      <span><b>${s.nombre}</b> <span class="mono">${s.id}</span></span>
      <span class="rmeta">${fmt(s)}</span>
    </div>`).join('');
}
function refreshTops(asis, entregas, presets){
  $('#tops-card').style.display='block';
  const stats = computeTopStats(asis, entregas, presets, TRI);
  const byAsist = [...stats].sort((a,b)=> b.asist_pct - a.asist_pct || a.nombre.localeCompare(b.nombre,'es'));
  const byTrab  = [...stats].sort((a,b)=> b.trab_pct  - a.trab_pct  || a.nombre.localeCompare(b.nombre,'es'));
  const byTotal = [...stats].sort((a,b)=> b.score     - a.score     || a.nombre.localeCompare(b.nombre,'es'));

  renderTopList('#top-asist', byAsist, s=> `${Math.round(s.asist_pct*100)}% ¬∑ A ${s.asist_present}/${s.asist_total} d`);
  renderTopList('#top-trab',  byTrab,  s=> `${Math.round(s.trab_pct*100)}% ¬∑ T ${s.trab_done}/${s.trab_total}`);
  renderTopList('#top-total', byTotal, s=> `${Math.round(s.score*100)} ¬∑ A ${s.asist_present}/${s.asist_total} ¬∑ T ${s.trab_done}/${s.trab_total} ¬∑ P ${s.pts}/${s.pts_total}`);
  const subt = (TRI==='ALL'?'Todo':TRI);
  $('#tops-sub').innerHTML = `Se actualiza con <b>${subt}</b>`;
}

/* ====== Render alumno ====== */
function setTriChips(){
  const host=$('#tri-chips');
  const opts=[['ALL','Todo'],['M1','M1'],['M2','M2'],['M3','M3']];
  host.innerHTML=opts.map(([v,l])=>`<button class="chip ${TRI===v?'active':''}" data-v="${v}">${l}</button>`).join('');
  for(const b of host.querySelectorAll('.chip')) b.onclick=()=>{
    TRI=b.getAttribute('data-v');
    setTriChips(); renderLists(); runWorkSearch();
    if(DATA.asis && DATA.reg && DATA.pre){
      refreshTops(DATA.asis, parseRegistro(DATA.reg.cols, DATA.reg.rows), parsePresets(DATA.pre.cols, DATA.pre.rows));
    }
  };
  $('#tri-subtitle').textContent='Resumen de '+({ALL:'Todo',M1:'Trimestre 1',M2:'Trimestre 2',M3:'Trimestre 3'}[TRI]);
}
function byTri(list){ return TRI==='ALL'? list : list.filter(x=>String(x.momento||'').toUpperCase()===TRI); }
function renderBarChart({faltantes,tarde,atiempo}){
  const max=Math.max(faltantes,tarde,atiempo,1);
  const set=(id,val)=>{ const el=$(id); el.style.setProperty('--pct',(val/max).toFixed(3)); el.querySelector('.val').textContent=val; };
  set('#bar-fal',faltantes); set('#bar-tar',tarde); set('#bar-ati',atiempo);
  $('#val-ati').textContent = atiempo;
}
function linksFor(uid){
  const rec = LINKMAP?.[uid];
  if(!rec) return '';
  const arr = Array.isArray(rec.urls) ? rec.urls : (rec.url?[rec.url]:[]);
  if(!arr.length) return '';
  return arr.map((u,i)=>`<a class="linkbtn" href="${u}" target="_blank" rel="noopener">üì∑ Ver evidencia ${arr.length>1?i+1:''}</a>`).join('');
}
function renderItem(t){
  const mom = t.momento ? ` ¬∑ ${t.momento}` : '';
  const the_fecha = t.fechaObjetivo ? ` ¬∑ ${normDate(t.fechaObjetivo)}` : '';
  const nom = t.nombreTrabajo ? ` ¬∑ <i>${t.nombreTrabajo}</i>` : '';
  const kLink = linksFor(t.uid);
  return `<details>
    <summary><b>${t.materia||'‚Äì'}</b> ‚Äî ${t.numero||'‚Äì'} (${t.origen||'‚Äì'}${t.pagina?' ¬∑ p.'+t.pagina:''})${nom}${the_fecha}${mom}${kLink? ' ' + kLink : ''}</summary>
  </details>`;
}
function renderGrouped(list){
  if(!list.length) return '<div class="hint">Sin elementos</div>';
  const map = new Map();
  for(const t of list){
    const m = t.materia || '‚Äì';
    if(!map.has(m)) map.set(m, []);
    map.get(m).push(t);
  }
  const mats = [...map.keys()].sort((a,b)=> String(a).localeCompare(String(b),'es',{sensitivity:'base'}));
  let html='';
  for(const m of mats){
    html += `<div class="materia-sep"><span>${m}</span></div>`;
    html += map.get(m).map(renderItem).join('');
  }
  return html;
}
function renderLists(){
  const falt=byTri(ALL.faltantes), tar=byTri(ALL.tarde), ati=byTri(ALL.atiempo);
  const totalTri = byTri(ALL.presets).length;
  const hechosTri = tar.length + ati.length;
  $('#stat-cump-tri').textContent = totalTri? `${Math.round(hechosTri/totalTri*100)}%` : '‚Äì';
  $('#stat-tot-tri').textContent  = `Faltantes ${falt.length} ¬∑ Tarde ${tar.length} ¬∑ A tiempo ${ati.length} ¬∑ Trabajos totales ${totalTri}`;
  renderBarChart({faltantes:falt.length, tarde:tar.length, atiempo:ati.length});

  $('#faltantes').innerHTML = falt.length ? renderGrouped(falt) : '<div class="hint">Sin faltantes</div>';
  $('#tarde').innerHTML     = tar.length   ? renderGrouped(tar)  : '<div class="hint">Sin entregas tarde</div>';
  $('#atiempo').innerHTML   = ati.length   ? renderGrouped(ati)  : '<div class="hint">A√∫n no hay entregas registradas</div>';
}

/* ====== CARGA DE ALUMNO ====== */
async function cargarAlumnoPorID(id){
  $('#student-view').style.display='none';
  $('#alumno-nombre').textContent='Cargando‚Ä¶'; $('#alumno-id').textContent='';

  await loadLinks();
  const [asis, reg, pre] = await Promise.all([loadBlock('asistencia'), loadBlock('registro'), loadBlock('presets')]);
  DATA.asis = asis; DATA.reg = reg; DATA.pre = pre;

  if (!STUDENTS.length){ STUDENTS = buildStudentIndexFromAsis(asis); renderAllList(); }

  const entregas = parseRegistro(reg.cols, reg.rows);
  const presets  = parsePresets(pre.cols, pre.rows);
  let entAlumno  = entregas.filter(t => norm(t.id) === norm(id));
  const nombreDeRegistro = entAlumno.find(e => e.nombre)?.nombre || '';

  const uids   = new Map(entAlumno.filter(t => t.uidPreset).map(t => [t.uidPreset, t]));
  const claves = new Map(entAlumno.filter(t => !t.uidPreset).map(t => [
    [norm(t.materia), norm(String(t.numero).replace(/^trabajo\s*/i,'')),
     norm(t.origen),  norm(t.pagina), normDate(t.fechaObjetivo)].join('|'), t
  ]));

  const faltantes=[], tarde=[], atiempo=[];
  for (const p of presets){
    let e = uids.get(p.uid);
    if (!e){
      const k = [norm(p.materia), norm(String(p.numero).replace(/^trabajo\s*/i,'')),
                 norm(p.origen),  norm(p.pagina), normDate(p.fechaObjetivo)].join('|');
      e = claves.get(k);
    }
    if (e) { (e.atrasoDias > 0 ? tarde : atiempo).push(p); } else { faltantes.push(p); }
  }
  ALL={faltantes,tarde,atiempo,presets};

  const [w0,w1] = weekRange(new Date());
  const aw = asistenciaAlumno(asis.cols, asis.rows, {id, nombre:nombreDeRegistro}, w0, w1, {excludeWeekends:true});

  const hoy = new Date();
  const d30 = ymd(new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate()-30));
  const start30 = (d30 < SCHOOL_YEAR_START) ? SCHOOL_YEAR_START : d30;

  const iNom = asis.cols.findIndex(c=>/^nombre/i.test(String(c)));
  let nombre = nombreDeRegistro;
  if (aw.row && iNom>=0) nombre = String(aw.row[iNom]||'');
  if (!nombre){
    const iId = findIDColumn(asis.cols, asis.rows);
    if (iId>=0 && iNom>=0){
      const r=asis.rows.find(r=>norm(r[iId])===norm(id));
      if (r) nombre=String(r[iNom]||'');
    }
  }
  if (!nombre){ alert('No encontramos ese ID. Verifique que est√© correcto o contacte a la escuela.'); return; }

  $('#alumno-nombre').textContent = nombre;
  $('#alumno-id').textContent     = 'ID: ' + id;
  $('#grupo-label').innerHTML     = `<span class="badgeb">üë©‚Äçüè´ Grupo: <b>${GROUP_LABEL}</b></span>`;

  const a30 = asistenciaAlumno(asis.cols, asis.rows, {id, nombre:nombre}, start30, ymd(hoy), {excludeWeekends:true});
  const ah  = asistenciaHistorica(asis.cols, asis.rows, {id, nombre:nombre}, {excludeWeekends:true});

  $('#stat-aswk').textContent   = aw.total  ? `${Math.round(aw.present/aw.total*100)}%  (${aw.present}/${aw.total})` : '‚Äì';
  $('#stat-as30').textContent   = a30.total ? `${Math.round(a30.present/a30.total*100)}%  (${a30.present}/${a30.total})` : '‚Äì';
  $('#stat-asHist').textContent = ah.total  ? `${Math.round(ah.present/ah.total*100)}%  (${ah.present}/${ah.total})` : '‚Äì';
  $('#stat-faltHist').textContent = ah.total ? `${ah.total - ah.present}` : '‚Äì';

  TRI='ALL'; setTriChips(); renderLists();
  refreshTops(asis, entregas, presets);
  runWorkSearch();

  $('#student-view').style.display='block';
  window.scrollTo({top:document.body.offsetTop, behavior:'smooth'});
}

/* ====== BUSCADOR (General/Alumno) ====== */
let SEARCH_SCOPE='AUTO'; // AUTO | GENERAL | ALUMNO
function setScope(scope){
  SEARCH_SCOPE = scope;
  document.querySelectorAll('#scope-chips .scope-chip').forEach(b=> b.classList.toggle('active', b.getAttribute('data-scope')===scope));
  const hint = scope==='GENERAL' ? '√Åmbito: <b>General</b>. Busca en todos los presets.'
             : scope==='ALUMNO'  ? '√Åmbito: <b>Alumno</b>. Busca en los <b>faltantes</b> del alumno abierto.'
             : '√Åmbito: <b>Auto</b>. Si hay alumno abierto, busca en sus faltantes; si no, busca en todos los presets.';
  $('#workSearchHint').innerHTML = hint;
  runWorkSearch();
}
$('#scope-chips').addEventListener('click', (e)=>{
  const btn=e.target.closest('.scope-chip'); if(!btn) return;
  setScope(btn.getAttribute('data-scope'));
});
$('#clearWorkSearch').onclick=()=>{ $('#workSearchInput').value=''; runWorkSearch(); };

function tokensOf(q){ return norm(q).split(/\s+/).filter(Boolean); }
function searchableText(p){ return norm([p.materia, p.nombreTrabajo, p.momento, p.numero, p.origen, p.pagina].filter(Boolean).join(' ')); }
function matchPreset(p, toks){ const hay = searchableText(p); return toks.every(t => hay.includes(t)); }
function renderSearchItem(p){
  const fecha = p.fechaObjetivo ? normDate(p.fechaObjetivo) : '‚Äì';
  const nom   = p.nombreTrabajo ? ` ¬∑ <i>${p.nombreTrabajo}</i>` : '';
  const mom   = p.momento ? `<span class="tag">${p.momento}</span>` : '';
  return `<div class="sg-item"><span><b>${p.materia||'‚Äì'}</b> ‚Äî ${p.numero||'‚Äì'}${nom} ${mom}</span><span class="tag">F. Obj ${fecha}</span></div>`;
}
function effectiveScope(){
  if(SEARCH_SCOPE!=='AUTO') return SEARCH_SCOPE;
  const sv = $('#student-view'); const alumnoAbierto = sv && sv.style.display!=='none';
  return alumnoAbierto ? 'ALUMNO' : 'GENERAL';
}
function runWorkSearch(){
  const q = $('#workSearchInput').value || '';
  const toks = tokensOf(q);
  const scope = effectiveScope();
  const host = $('#workSearchResults');
  host.innerHTML = '';

  if(!toks.length){ host.innerHTML = '<div class="search-empty">Escribe para buscar‚Ä¶</div>'; return; }

  if(scope==='GENERAL'){
    if(!DATA.pre){ host.innerHTML = '<div class="search-empty">A√∫n no se cargaron los presets.</div>'; return; }
    const base = parsePresets(DATA.pre.cols, DATA.pre.rows);
    const list = TRI==='ALL'? base : base.filter(p => String(p.momento||'').toUpperCase()===TRI);
    const res = list.filter(p => matchPreset(p, toks));
    host.innerHTML = res.length ? res.map(renderSearchItem).join('') : '<div class="search-empty">Sin coincidencias en presets.</div>';
  }else{
    const base = byTri(ALL.faltantes);
    if(!base.length){ host.innerHTML = '<div class="search-empty">No hay faltantes (o no hay alumno abierto).</div>'; return; }
    const res = base.filter(p => matchPreset(p, toks));
    host.innerHTML = res.length ? res.map(renderSearchItem).join('') : '<div class="search-empty">Sin coincidencias en faltantes del alumno.</div>';
  }
}
$('#workSearchInput').addEventListener('input', debounce(runWorkSearch, 200));
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* ====== NAV / BUSCADOR ALUMNO ====== */
let SG_VISIBLE=false;
function hideSG(){ SG_VISIBLE=false; $('#sgBox').style.display='none'; }
function showSG(items){
  const box=$('#sgBox');
  box.innerHTML = items.map((s)=>`<div class="sg-item" data-id="${s.id}">
      <span>${s.nombre}</span><span class="tag">${s.id}</span></div>`).join('');
  box.querySelectorAll('.sg-item').forEach(el=>{
    el.onclick=()=>{ $('#searchInput').value = el.children[0].textContent; openById(el.getAttribute('data-id')); hideSG(); };
  });
  SG_VISIBLE=true; box.style.display='block';
}
function filterSG(q){
  const t=norm(q);
  if(t.length<2 || !STUDENTS.length){ hideSG(); return; }
  const best = STUDENTS.filter(s => norm(s.nombre).includes(t) || norm(s.id).includes(t)).slice(0,12);
  if(!best.length){ hideSG(); return; }
  showSG(best);
}
function openById(id){
  if(!id){ alert('Falta ID'); return; }
  const idx = STUDENTS.findIndex(s=>s.id===id);
  if(idx>=0) CURRENT_INDEX = idx;
  cargarAlumnoPorID(id);
}
function openStudentByIndex(i){
  if(i<0 || i>=STUDENTS.length) return;
  CURRENT_INDEX=i;
  const s=STUDENTS[i];
  $('#searchInput').value=s.nombre;
  localStorage.setItem('docente_last', s.nombre);
  openById(s.id);
}
$('#saveBtn').onclick=()=>{const v=$('#searchInput').value.trim(); if(!v){alert('Escribe nombre o ID.'); return;} localStorage.setItem('docente_last',v); alert('Listo. Guardado.');};
$('#openBtn').onclick=()=>{
  const q=$('#searchInput').value.trim();
  if(!q){ alert('Escribe nombre o ID.'); return; }
  const m=q.toUpperCase().match(/^ID[A-Z0-9]{6,}$/);
  if(m){ openById(m[0]); return; }
  const t=norm(q);
  let hit = STUDENTS.find(s => norm(s.nombre)===t);
  if(!hit) hit = STUDENTS.find(s => norm(s.nombre).includes(t));
  if(!hit){ alert('No hall√© ese alumno. Prueba otra parte del nombre o pega el ID.'); return; }
  openById(hit.id);
};
$('#searchInput').addEventListener('input', e=>filterSG(e.target.value));
document.addEventListener('click', e=>{ if(!$('#sgBox').contains(e.target) && e.target!==$('#searchInput')) hideSG(); });
$('#listAllBtn').onclick=()=>{
  const el=$('#allList');
  if(!STUDENTS.length){ alert('A√∫n no se cargan alumnos. Revisa acceso a la hoja Asistencia.'); return; }
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
};
$('#prevBtn').onclick=()=>{ if(CURRENT_INDEX<=0) return; openStudentByIndex(CURRENT_INDEX-1); };
$('#nextBtn').onclick=()=>{ if(CURRENT_INDEX<0 || CURRENT_INDEX>=STUDENTS.length-1) return; openStudentByIndex(CURRENT_INDEX+1); };
$('#backBtn')?.addEventListener('click',()=>{ $('#student-view').style.display='none'; window.scrollTo({top:0,behavior:'smooth'}); });

/* ====== TEMA ====== */
const themeBtn=$('#themeBtn');
function applyTheme(t){document.documentElement.setAttribute('data-theme', t); themeBtn.textContent=(t==='dark'?'‚òÄÔ∏è Claro':'üåô Oscuro'); localStorage.setItem('docente_theme',t);}
applyTheme(localStorage.getItem('docente_theme')||'light');
themeBtn.onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* ====== START ====== */
(async function init(){
  await loadLinks();
  try{
    const asis = await loadBlock('asistencia');
    DATA.asis = asis;
    STUDENTS = buildStudentIndexFromAsis(asis);
    renderAllList();

    const [reg, pre] = await Promise.all([loadBlock('registro'), loadBlock('presets')]);
    DATA.reg = reg; DATA.pre = pre;

    refreshTops(asis, parseRegistro(reg.cols, reg.rows), parsePresets(pre.cols, pre.rows));
    $('#tops-card').style.display='block';
  }catch(e){ console.warn('No se pudo leer datos', e); }

  const last = localStorage.getItem('docente_last');
  if(last) $('#searchInput').value = last;

  setScope('AUTO');
})();
$('#recalcTopsBtn').onclick = ()=>{
  if(DATA.asis && DATA.reg && DATA.pre){
    refreshTops(DATA.asis, parseRegistro(DATA.reg.cols, DATA.reg.rows), parsePresets(DATA.pre.cols, DATA.pre.rows));
  }
};
</script>
</body>
</html>
